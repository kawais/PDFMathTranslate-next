name: macOS Build

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-macos:
    name: Build on ${{ matrix.runs_on }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        runs_on: [macos-13, macos-14]
        python-version: ['3.12']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Show env
        run: |
          sw_vers
          uname -a
          python -V

      - name: Determine arch
        run: echo "ARCH=$(uname -m)" >> $GITHUB_ENV

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Install project, headless OpenCV and PyInstaller
        run: |
          python -m pip install .
          python -m pip install pyinstaller opencv-python-headless

      - name: Create PyInstaller spec and hook (no repo files needed)
        run: |
          mkdir -p .tmp_hooks
          cat > .tmp_hooks/hook-cv2.py << 'PY'
          from PyInstaller.utils.hooks import (
              collect_data_files,
              collect_dynamic_libs,
              collect_submodules,
          )

          hiddenimports = collect_submodules('cv2')

          datas = []
          datas += collect_data_files('cv2', include_py_files=False)

          _bins = collect_dynamic_libs('cv2')
          binaries = []
          for src, dest in _bins:
              base = src.split('/')[-1]
              if 'libbluray' in base:
                  continue
              binaries.append((src, dest))
          PY

          cat > pyinstaller.macos.spec << 'SPEC'
          # -*- mode: python ; coding: utf-8 -*-

          import os
          from PyInstaller.utils.hooks import collect_submodules, collect_data_files, collect_dynamic_libs

          entry_script = os.path.join('pdf2zh_next', 'main.py')

          hiddenimports = []
          hiddenimports += collect_submodules('babeldoc')

          datas = []
          datas += collect_data_files('babeldoc', include_py_files=False)
          datas += collect_data_files('pdf2zh_next', include_py_files=False)

          binaries = []
          cv2_bins = collect_dynamic_libs('cv2')
          filtered_cv2_bins = []
          for src, dest in cv2_bins:
              base = os.path.basename(src)
              if 'libbluray' in base:
                  continue
              filtered_cv2_bins.append((src, dest))
          binaries += filtered_cv2_bins

          block_cipher = None

          a = Analysis(
              [entry_script],
              pathex=[os.getcwd()],
              binaries=binaries,
              datas=datas,
              hiddenimports=hiddenimports,
              hookspath=['.tmp_hooks'],
              runtime_hooks=[],
              excludes=[],
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              [],
              exclude_binaries=True,
              name='pdf2zh',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=False,
              console=True,
              disable_windowed_traceback=False,
          )

          coll = COLLECT(
              exe,
              a.binaries,
              a.zipfiles,
              a.datas,
              strip=False,
              upx=False,
              upx_exclude=[],
              name='pdf2zh'
          )
          SPEC

      - name: Build with PyInstaller spec (filter cv2 libbluray)
        run: |
          pyinstaller --clean -y pyinstaller.macos.spec

      - name: Prepare package
        run: |
          mkdir -p release
          mkdir -p "release/pdf2zh-next-macos-${ARCH}"
          cp -R dist/pdf2zh "release/pdf2zh-next-macos-${ARCH}/"
          cp README.md LICENSE "release/pdf2zh-next-macos-${ARCH}/"
          cd release
          ZIP_NAME="pdf2zh-next-${{ github.ref_type == 'tag' && github.ref_name || 'dev' }}-macos-${ARCH}.zip"
          /usr/bin/zip -r "$ZIP_NAME" "pdf2zh-next-macos-${ARCH}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf2zh-next-macos-${{ env.ARCH }}
          path: release/*.zip

      - name: Upload release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.zip


